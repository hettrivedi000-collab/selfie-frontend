<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Selfie Verification</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      min-height: 100vh;
      background: #efb028;
      display: flex;
      justify-content: center;
      padding-top: 110px;
      color: #fff;
    }

    .top-header {
      position: fixed;
      top: 0;
      width: 100%;
      height: 110px;
      background: linear-gradient(135deg, #ff6a00, #ff8c1a);
      display: flex;
      align-items: center;
      justify-content: space-around;
      padding: 0 10px;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    .logo1 { width: 70px; }
    .logo2 { width: 80px; }

    .app {
      width: 95%;
      max-width: 420px;
      background: #eb9c56;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      margin-bottom: 40px;
    }

    .app-image-container {
      width: 100%;
      height: 240px;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 15px;
    }

    .app-image-container img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      background: #eb9c56;
    }

    input, button {
      width: 100%;
      padding: 14px;
      margin-top: 12px;
      border-radius: 10px;
      border: none;
      font-size: 16px;
      display: block;
    }

    input {
      background: white;
      color: #333;
    }

    button {
      background: #22c55e;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    button.secondary { background: #f97316; }
    button.download { background: #ffffff; color: #ff6a00; }

    .camera-box {
      display: none;
      position: relative;
      width: 100%;
      aspect-ratio: 3/4;
      background: black;
      border-radius: 12px;
      overflow: hidden;
      margin-top: 10px;
    }

    video, canvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    canvas { z-index: 2; }

    video {
      opacity: 0;
    }

    .preview {
      display: none;
      width: 100%;
      aspect-ratio: 3/4;
      margin-top: 10px;
      border-radius: 12px;
      overflow: hidden;
    }

    .preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .status {
      text-align: center;
      margin-top: 15px;
      font-size: 14px;
      min-height: 22px;
      color: #fff;
      font-weight: 500;
    }

    .closing-message {
      text-align: center;
      margin-top: 10%;
      font-size: 24px;
      font-weight: bold;
      color: white;
      padding: 20px;
    }
  </style>
</head>

<body>

<header class="top-header">
  <img src="hngu.jpeg" class="logo1">
  <img src="logo.png" class="logo2">
</header>

<div class="app" id="mainApp">
  <div class="app-image-container">
    <img src="sts2.png" alt="Banner Image">
  </div>

  <div id="formSection">
    <input id="name" type="text" placeholder="Full Name">
    <input id="mobile" type="tel" placeholder="Mobile Number" maxlength="10">
    <input id="city" type="text" placeholder="City">
    <input id="occupation" type="text" placeholder="Occupation">
    <button id="submitBtn">Open Camera</button>
  </div>

  <div class="camera-box" id="cameraBox">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>
  </div>

  <div class="preview" id="previewBox">
    <img id="previewImg">
  </div>

  <button id="captureBtn" style="display:none;">Capture Photo</button>
  <button id="retakeBtn" class="secondary" style="display:none;">Retake</button>
  <button id="downloadBtn" class="download" style="display:none;">Download संकल्प पत्र</button>

  <div class="status" id="status"></div>
</div>

<img id="fixedBg" src="Admin_building2.jpeg" style="display:none">
<img id="certBg" src="certificate.png" style="display:none">

<script>
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");

  const nameInput = document.getElementById("name");
  const mobileInput = document.getElementById("mobile");
  const cityInput = document.getElementById("city");
  const occupationInput = document.getElementById("occupation");

  const submitBtn = document.getElementById("submitBtn");
  const captureBtn = document.getElementById("captureBtn");
  const retakeBtn = document.getElementById("retakeBtn");
  const downloadBtn = document.getElementById("downloadBtn");

  const formSection = document.getElementById("formSection");
  const cameraBox = document.getElementById("cameraBox");
  const previewBox = document.getElementById("previewBox");
  const previewImg = document.getElementById("previewImg");
  const statusText = document.getElementById("status");

  const fixedBg = document.getElementById("fixedBg");
  let bgReady = false;
  fixedBg.onload = () => bgReady = true;

  const BACKEND_URL = "https://selfie-backend-d7y8.onrender.com/upload";

  let selfieSegmentation;
  let isCameraRunning = false;
  let lastFrameReady = false;

  selfieSegmentation = new SelfieSegmentation({
    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${file}`
  });

  selfieSegmentation.setOptions({ modelSelection: 1 });
  selfieSegmentation.onResults(onResults);

  submitBtn.onclick = () => {
    if (!/^[A-Za-z ]{2,}$/.test(nameInput.value)) { statusText.innerText = "Enter valid name"; return; }
    if (!/^[6-9]\d{9}$/.test(mobileInput.value)) { statusText.innerText = "Enter valid 10-digit mobile number"; return; }
    if (cityInput.value.trim() === "" || occupationInput.value.trim() === "") { statusText.innerText = "Required fields missing"; return; }
    formSection.style.display = "none";
    cameraBox.style.display = "block";
    captureBtn.style.display = "block";
    statusText.innerText = "Initializing Camera...";
    startCamera();
  };

  async function startCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "user", width: { ideal: 600 }, height: { ideal: 480 } },
        audio: false
      });
      video.srcObject = stream;
      isCameraRunning = true;
      video.onloadedmetadata = () => {
        video.play();
        statusText.innerText = "";
        requestAnimationFrame(processVideo);
      };
    } catch (err) { statusText.innerText = "Camera access denied."; }
  }

  async function processVideo() {
    if (!isCameraRunning) return;
    if (video.readyState === 4) await selfieSegmentation.send({ image: video });
    requestAnimationFrame(processVideo);
  }

  function onResults(results) {
  if (!bgReady) return;

  if (canvas.width !== video.videoWidth || canvas.height !== video.videoHeight) {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
  }

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  const selfieHeight = canvas.height * 0.6;
  const selfieY = canvas.height - selfieHeight;

  const scale = 0.8; 
  const drawWidth = canvas.width * scale;
  const drawX = (canvas.width - drawWidth) / 2;

  ctx.save();
  ctx.translate(canvas.width, 0);
  ctx.scale(-1, 1);

  ctx.drawImage(
    results.image,
    drawX,
    selfieY,
    drawWidth,
    selfieHeight
  );

  ctx.globalCompositeOperation = "destination-in";

  ctx.drawImage(
    results.segmentationMask,
    drawX,
    selfieY,
    drawWidth,
    selfieHeight
  );
  ctx.restore();

  ctx.globalCompositeOperation = "destination-over";

  ctx.drawImage(fixedBg, 0, 0, canvas.width, canvas.height);

  ctx.globalCompositeOperation = "source-over";
  lastFrameReady = true;
}



  captureBtn.onclick = () => {
    if (!lastFrameReady) return;const imgCanvas = document.createElement("canvas");

    const scaleFactor = 2;
    imgCanvas.width = canvas.width * scaleFactor;
    imgCanvas.height = canvas.height * scaleFactor;

    const ictx = imgCanvas.getContext("2d");
    ictx.imageSmoothingEnabled = true;
    ictx.imageSmoothingQuality = "high";

    ictx.drawImage(
      canvas,0, 0,imgCanvas.width,imgCanvas.height
    );

  previewImg.src = imgCanvas.toDataURL("image/jpeg", 0.95);

    isCameraRunning = false;
    if (video.srcObject) video.srcObject.getTracks().forEach(track => track.stop());
    cameraBox.style.display = "none";
    previewBox.style.display = "block";
    captureBtn.style.display = "none";
    retakeBtn.style.display = "block";
    downloadBtn.style.display = "block";
    statusText.innerText = "Selfie captured successfully";
  };

  retakeBtn.onclick = () => {
    previewBox.style.display = "none";
    cameraBox.style.display = "block";
    captureBtn.style.display = "block";
    retakeBtn.style.display = "none";
    downloadBtn.style.display = "none";
    startCamera();
  };

  async function uploadToBackend() {
    const userData = {
      name: nameInput.value,
      mobile: mobileInput.value,
      city: cityInput.value,
      occupation: occupationInput.value
    };
    try {
      await fetch(BACKEND_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(userData),
      });
    } catch (error) { console.error("Error:", error); }
  }

  function wrapText(context, text, x, y, maxWidth, lineHeight, userName) {
    const lines = text.split('\n');
    let currentY = y;
    for (let i = 0; i < lines.length; i++) {
        let words = lines[i].split(' ');
        let currentX = x;
        for (let n = 0; n < words.length; n++) {
            let word = words[n];
            let isName = (userName && (word === userName || word.includes(userName)));
            context.font = isName ? "bold 50px Georgia, serif" : "46px Georgia, serif";
            let wordWidth = context.measureText(word + ' ').width;
            if (currentX + wordWidth > x + maxWidth && currentX > x) {
                currentY += lineHeight;
                currentX = x;
            }
            context.save();
            context.fillStyle = isName ? "#550000" : "#8B0000";
            context.fillText(word, currentX, currentY);
            context.restore();
            currentX += wordWidth;
        }
        currentY += lineHeight;
    }
  }

  downloadBtn.onclick = () => {

  const certCanvas = document.createElement("canvas");
  const cctx = certCanvas.getContext("2d");

  certCanvas.width = 1080;
  certCanvas.height = 1920;

  const certBgImage = document.getElementById("certBg");
  cctx.drawImage(certBgImage, 0, 0, 1080, 1920);

const photoW = 296;
const photoH = 404;

const photoX = 40;
const photoY = certCanvas.height - photoH - 86;

cctx.imageSmoothingEnabled = true;
cctx.imageSmoothingQuality = "high";

cctx.drawImage(
  previewImg,
  photoX,
  photoY,
  photoW,
  photoH
);

certCanvas.toBlob(function(blob) {

  const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

  if (isIOS) {
    const url = URL.createObjectURL(blob);
    window.location.href = url;
  } else {
    const link = document.createElement("a");
    link.download = "Certificate.png";
    link.href = URL.createObjectURL(blob);
    link.click();
  }

}, "image/png", 1.0);

  uploadToBackend();

  setTimeout(() => {
    document.body.innerHTML =
      '<div class="closing-message">Certificate Saved!<br><br>You can now close this page.</div>';
  }, 1500);
};

</script>

</body>
</html>
